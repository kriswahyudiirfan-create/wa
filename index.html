<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyWA - Galau</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #0b141a; color: #e9edef; overflow: hidden; }
        .hidden { display: none !important; }

        /* Animasi Tebasan untuk Kontak */
        @keyframes slashIn {
            0% { transform: translateX(-100%) skewX(-20deg); opacity: 0; }
            70% { transform: translateX(5%) skewX(10deg); opacity: 1; }
            100% { transform: translateX(0) skewX(0deg); }
        }

        #contact-outer { flex: 1; margin: 10px; border-radius: 15px; position: relative; padding: 2px; overflow: hidden; background: #202c33; }
        #contact-outer::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, transparent, transparent, #00ffcc); animation: rotateBorder 3s linear infinite; z-index: 0; }
        @keyframes rotateBorder { 100% { transform: rotate(360deg); } }

        .eye-container { position: fixed; top: 15px; left: 15px; width: 60px; height: 35px; display: flex; gap: 12px; z-index: 2000; pointer-events: none; }
        .eye { width: 22px; height: 18px; background: #fff; border-radius: 50% 50% 40% 40%; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1.5px solid #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); animation: blinkEye 4s infinite; }
        .pupil { width: 9px; height: 9px; background: #000; border-radius: 50%; border: 2px solid #ff0000; animation: creepyLook 3s infinite; }
        @keyframes blinkEye { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
        @keyframes creepyLook { 0% { transform: translate(0, 0); } 20% { transform: translate(5px, -3px); } 40% { transform: translate(-5px, 3px) scale(1.2); } 60% { transform: translate(0, 5px); } 100% { transform: translate(0, 0); } }

        #welcome-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 1s; }
        .welcome-text { font-size: 24px; font-weight: bold; color: #00a884; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        #auth-screen { padding: 50px 20px; text-align: center; }
        input[type="text"] { width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #2a3942; background: #2a3942; color: white; }
        button { background: #00a884; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

        #app { display: flex; flex-direction: column; height: 100vh; }
        header { background: #202c33; padding: 15px; text-align: center; position: relative; }
        #cool-anim { font-size: 14px; color: #00a884; position: absolute; width: 100%; top: 5px; left: 0; animation: slideToggle 2s infinite; }
        @keyframes slideToggle { 0%, 100% { transform: translateY(-20px); opacity: 0; } 50% { transform: translateY(0); opacity: 1; } }

        #contact-container { position: relative; height: 100%; width: 100%; background: #0b141a; border-radius: 12px; overflow-y: auto; padding: 5px; z-index: 1; }
        .search-box { padding: 10px; background: #111b21; }
        .search-box input { width: 100%; padding: 8px; border-radius: 5px; border: none; background: #2a3942; color: white; }

        .contact-card { background: #111b21; padding: 12px; border-bottom: 1px solid #222d34; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 5px; animation: slashIn 0.5s ease forwards; }
        .my-self-card { border-left: 4px solid #00a884; background: #1a2a24; }
        .contact-info { flex: 1; cursor: pointer; }
        .contact-info b { display: block; color: #e9edef; font-size: 16px; }
        .contact-info span { font-size: 12px; color: #8696a0; display: block; margin: 2px 0; }
        .last-msg { font-size: 13px; color: #00a884; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .btn-del { background: none; border: none; color: #ef5350; font-size: 18px; padding: 10px; cursor: pointer; opacity: 0.6; }

        #chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; z-index: 100; display: flex; flex-direction: column; }
        #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg-bubble { max-width: 80%; padding: 10px; border-radius: 10px; margin-bottom: 8px; position: relative; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #005c4b; }
        .msg-them { align-self: flex-start; background: #202c33; }
        .msg-time { font-size: 10px; color: #8696a0; text-align: right; margin-top: 5px; }
        .status-icon { font-size: 12px; margin-left: 5px; }
        .c1, .c2 { color: #8696a0; } .c3 { color: #53bdeb; }

        .input-bar { background: #202c33; padding: 10px; display: flex; align-items: center; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 10px; border-radius: 8px; color: white; }
        .file-btn { margin-right: 10px; font-size: 22px; cursor: pointer; }

        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; border: 1px solid #333; cursor: pointer; }
        .download-link { background: #343f46; color: #e9edef; padding: 8px 12px; border-radius: 5px; text-decoration: none; margin-top: 8px; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; border: 1px solid #444; }
    </style>
</head>
<body>

    <div class="eye-container">
        <div class="eye"><div class="pupil"></div></div>
        <div class="eye"><div class="pupil"></div></div>
    </div>

    <div id="welcome-layer"><div class="welcome-text">SELAMAT DATANG</div></div>

    <div id="auth-screen" class="hidden">
        <h2>Bikin ID Permanen</h2>
        <input type="text" id="my-id-input" placeholder="Huruf atau Angka...">
        <br>
        <button id="btn-buat-id" onclick="saveID()">BUAT ID</button>
    </div>

    <div id="app" class="hidden">
        <header>
            <div id="cool-anim">SISTEM AKTIF ‚Ä¢ TERENKRIPSI</div>
            <h3>Daftar Kontak</h3>
            <button onclick="openAddContact()" style="position:absolute; right:10px; top:12px; padding:5px 10px;">+ ID</button>
        </header>
        <div class="search-box"><input type="text" id="search-input" placeholder="Cari Nama atau ID..." oninput="renderContacts()"></div>
        <div id="contact-outer"><div id="contact-container"><div id="list-kontak"></div></div></div>
    </div>

    <div id="chat-window" class="hidden">
        <header style="display:flex; align-items:center; background:#202c33; padding:10px;">
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px; margin-right:15px;">‚Üê</button>
            <div id="chat-target-info"></div>
        </header>
        <div id="msg-area"></div>
        <div class="input-bar">
            <label class="file-btn">üìé<input type="file" id="file-input" class="hidden" onchange="uploadFile()"></label>
            <input type="text" id="text-input" placeholder="Ketik pesan...">
            <button onclick="sendText()" style="margin-left:10px;">‚û§</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
            authDomain: "mywa-irfank.firebaseapp.com",
            databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
            projectId: "mywa-irfank",
            storageBucket: "mywa-irfank.firebasestorage.app",
            messagingSenderId: "567484997979",
            appId: "1:567484997979:web:743ea53391552dfde07a7e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        // Aktifkan Offline Persistence agar kontak muncul instan meski internet lemot
        // Catatan: Database tetap sinkron saat browser dibuka kembali
        
        let myID = localStorage.getItem('my_wa_id');
        let activeChatID = null;
        let contacts = JSON.parse(localStorage.getItem('my_contacts') || '{}');
        let aliasMemory = JSON.parse(localStorage.getItem('alias_memory') || '{}');
        let sessionStartTime = Date.now();

        function encryptText(text) { try { return btoa(unescape(encodeURIComponent(text))); } catch(e) { return text; } }
        function decryptText(encoded) { try { return decodeURIComponent(escape(atob(encoded))); } catch(e) { return encoded; } }

        setTimeout(() => {
            document.getElementById('welcome-layer').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-layer').classList.add('hidden');
                if (!myID) document.getElementById('auth-screen').classList.remove('hidden');
                else startApp();
            }, 1000);
        }, 2000);

        function saveID() {
            let id = document.getElementById('my-id-input').value.trim();
            if (!id) return;
            db.ref('users/' + id).get().then(snap => {
                if (snap.exists()) { alert("ID sudah ada pemiliknya!"); }
                else {
                    db.ref('users/' + id).set({ status: 'online' });
                    localStorage.setItem('my_wa_id', id);
                    myID = id;
                    startApp();
                }
            });
        }

        function startApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            renderContacts();
            listenGlobal(); 
            db.ref('users/' + myID).update({ status: 'online' });
            // Handle offline status
            db.ref('users/' + myID).onDisconnect().update({ status: 'offline' });
        }

        function openAddContact() {
            let target = prompt("Masukkan ID tujuan:");
            if (!target || target == myID) return;
            let alias = prompt("Beri nama khusus (Alias):");
            saveToContacts(target, alias);
        }

        function saveToContacts(id, alias) {
            contacts[id] = alias || id;
            aliasMemory[id] = alias || id; 
            localStorage.setItem('my_contacts', JSON.stringify(contacts));
            localStorage.setItem('alias_memory', JSON.stringify(aliasMemory));
            renderContacts();
        }

        function deleteContact(id) {
            if (confirm(`Hapus ${contacts[id] || id} dari daftar?`)) {
                delete contacts[id];
                localStorage.setItem('my_contacts', JSON.stringify(contacts));
                renderContacts();
            }
        }

        function renderContacts() {
            const list = document.getElementById('list-kontak');
            const search = document.getElementById('search-input').value.toLowerCase();
            list.innerHTML = '';

            if (!search || myID.toLowerCase().includes(search) || "saya".includes(search)) {
                list.innerHTML += `
                    <div class="contact-card my-self-card" style="animation-delay: 0.1s">
                        <div class="contact-info" onclick="openChat('${myID}')">
                            <b>Saya (Simpan Pesan)</b>
                            <span>ID: ${myID}</span>
                            <div class="last-msg">Catatan pribadi kamu</div>
                        </div>
                    </div>`;
            }

            let i = 0;
            for (let id in contacts) {
                i++;
                let alias = contacts[id];
                if (id.toLowerCase().includes(search) || alias.toLowerCase().includes(search)) {
                    let cardID = 'card-' + id.replace(/\s+/g, '-');
                    list.innerHTML += `<div id="${cardID}" style="animation-delay: ${0.1 + (i*0.05)}s"></div>`;
                    
                    // Gunakan 'once' untuk load pertama agar cepat, lalu 'on' untuk update
                    db.ref(`chats/${myID}/${id}`).limitToLast(1).on('value', snap => {
                        let lastMsg = "Belum ada pesan";
                        snap.forEach(c => {
                            let val = c.val();
                            lastMsg = val.type === 'text' ? decryptText(val.text) : "üìé Media/File";
                        });
                        const targetDiv = document.getElementById(cardID);
                        if (targetDiv) {
                            targetDiv.innerHTML = `
                            <div class="contact-card">
                                <div class="contact-info" onclick="openChat('${id}')">
                                    <b>${alias}</b>
                                    <span>ID: ${id}</span>
                                    <div class="last-msg">${lastMsg}</div>
                                </div>
                                <button class="btn-del" onclick="deleteContact('${id}')">‚úï</button>
                            </div>`;
                        }
                    });
                }
            }
        }

        function openChat(id) {
            activeChatID = id;
            document.getElementById('chat-window').classList.remove('hidden');
            let displayName = id === myID ? "Simpan Pesan" : (contacts[id] || id);
            document.getElementById('chat-target-info').innerHTML = `<b>${displayName}</b><br><small style="color:#8696a0">${id}</small>`;
            loadMessages(id);
        }

        function closeChat() { activeChatID = null; document.getElementById('chat-window').classList.add('hidden'); }

        function sendText() {
            let txt = document.getElementById('text-input').value;
            if(!txt) return;
            pushMsg({ text: txt, type: 'text' });
            document.getElementById('text-input').value = '';
        }

        function pushMsg(data) {
            let now = new Date();
            let dateStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            let fullDate = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if(data.type === 'text') data.text = encryptText(data.text);
            let payload = { ...data, sender: myID, time: dateStr, fullDate: fullDate, ts: Date.now(), status: 1 };
            
            // Firebase secara otomatis akan mengantre pesan ini jika sedang offline
            db.ref(`chats/${myID}/${activeChatID}`).push(payload);
            if(activeChatID !== myID) {
                db.ref(`chats/${activeChatID}/${myID}`).push(payload);
            }
        }

        function loadMessages(target) {
            const area = document.getElementById('msg-area');
            db.ref(`chats/${myID}/${target}`).off();
            db.ref(`chats/${myID}/${target}`).on('value', snap => {
                area.innerHTML = '';
                snap.forEach(child => {
                    let m = child.val();
                    let isMe = m.sender === myID;
                    let content = "";
                    if(m.type === 'text') content = `<div>${decryptText(m.text)}</div>`;
                    else if(m.type === 'image') content = `<img src="${m.url}" class="chat-img" onclick="window.open('${m.url}')"><br><a href="${m.url}" download="${m.fileName}" target="_blank" class="download-link">üì• Download Gambar</a>`;
                    else if(m.type === 'file') content = `<div style="background:rgba(0,0,0,0.1);padding:8px;border-radius:5px;border:1px solid #444">üìÑ ${m.fileName}</div><a href="${m.url}" download="${m.fileName}" target="_blank" class="download-link">üì• Download File</a>`;
                    
                    let statusClass = m.status === 3 ? "c3" : (m.status === 2 ? "c2" : "c1");
                    area.innerHTML += `
                        <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-them'}">
                            <div style="font-size:9px; opacity:0.7; margin-bottom:3px;">${m.fullDate || ''}</div>
                            ${content}
                            <div class="msg-time">
                                ${m.time} ${isMe ? `<span class="status-icon ${statusClass}">‚úì‚úì</span>` : ''}
                            </div>
                        </div>`;
                });
                area.scrollTop = area.scrollHeight;
            });
        }

        function uploadFile() {
            let fileInput = document.getElementById('file-input');
            let file = fileInput.files[0];
            if(!file) return;
            let fileName = file.name;
            let isImg = file.type.includes('image');
            let reader = new FileReader();
            reader.onload = function(e) {
                let instantUrl = e.target.result;
                let now = new Date();
                let dateStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
                let fullDate = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                let payload = { url: instantUrl, type: isImg ? 'image' : 'file', fileName: fileName, sender: myID, time: dateStr, fullDate: fullDate, ts: Date.now(), status: 1 };
                let myMsgRef = db.ref(`chats/${myID}/${activeChatID}`).push(payload);
                let targetMsgRef = activeChatID !== myID ? db.ref(`chats/${activeChatID}/${myID}`).push(payload) : null;
                let storageRef = storage.ref(`uploads/${Date.now()}_${fileName}`);
                storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(realUrl => {
                    myMsgRef.update({ url: realUrl });
                    if(targetMsgRef) targetMsgRef.update({ url: realUrl });
                });
            };
            reader.readAsDataURL(file);
            fileInput.value = "";
        }

        function listenGlobal() {
            // Memantau root chats untuk mendeteksi chat baru dari siapapun
            db.ref(`chats/${myID}`).on('child_added', snap => {
                let foreignID = snap.key;
                if(foreignID === myID) return;

                // Pantau setiap pesan masuk secara real-time
                db.ref(`chats/${myID}/${foreignID}`).on('child_added', msgSnap => {
                    let msgData = msgSnap.val();
                    
                    // Logika deteksi chat dari orang yang tidak ada di daftar kontak
                    if(!contacts[foreignID] && msgData.ts > sessionStartTime) {
                        if (aliasMemory[foreignID]) {
                            // Jika sudah ada di memori, langsung munculkan (No delay)
                            contacts[foreignID] = aliasMemory[foreignID];
                            localStorage.setItem('my_contacts', JSON.stringify(contacts));
                            renderContacts();
                        } else {
                            // Hanya minta nama jika benar-benar ID asing baru
                            let askAlias = prompt(`Pesan baru dari ID: ${foreignID}\nBeri nama kontak:`);
                            saveToContacts(foreignID, askAlias);
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>

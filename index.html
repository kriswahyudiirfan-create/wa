<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyWA - IrfanK Fast Security</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #0b141a; color: #e9edef; overflow: hidden; }
        .hidden { display: none !important; }

        @keyframes smoothEntry { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #contact-outer { flex: 1; margin: 10px; border-radius: 15px; position: relative; padding: 2px; overflow: hidden; background: #202c33; }
        #contact-outer::before { content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, transparent, transparent, #00ffcc); animation: rotateBorder 3s linear infinite; z-index: 0; }
        @keyframes rotateBorder { 100% { transform: rotate(360deg); } }

        #welcome-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.5s; }
        .welcome-text { font-size: 24px; font-weight: bold; color: #00a884; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        #auth-screen { padding: 40px 20px; text-align: center; height: 100vh; overflow-y: auto; }
        input[type="text"], input[type="password"] { width: 80%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #2a3942; background: #2a3942; color: white; outline: none; }
        button { background: #00a884; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin: 5px; transition: 0.1s; }
        button:active { transform: scale(0.95); }
        
        #app { display: flex; flex-direction: column; height: 100vh; }
        header { background: #202c33; padding: 15px; text-align: center; position: relative; }
        #cool-anim { font-size: 14px; color: #00a884; position: absolute; width: 100%; top: 5px; left: 0; animation: slideToggle 2s infinite; }
        @keyframes slideToggle { 0%, 100% { transform: translateY(-20px); opacity: 0; } 50% { transform: translateY(0); opacity: 1; } }

        #status-bar { display: flex; overflow-x: auto; padding: 10px; background: #111b21; gap: 10px; border-bottom: 1px solid #222d34; scrollbar-width: none; }
        #status-bar::-webkit-scrollbar { display: none; }
        .status-circle { min-width: 60px; text-align: center; cursor: pointer; }
        .status-thumb { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #00a884; display: flex; align-items: center; justify-content: center; font-size: 10px; background: #2a3942; margin: 0 auto; overflow: hidden; }

        #contact-container { position: relative; height: 100%; width: 100%; background: #0b141a; border-radius: 12px; overflow-y: auto; padding: 5px; z-index: 1; }
        .contact-card { background: #111b21; padding: 12px; border-bottom: 1px solid #222d34; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 5px; animation: smoothEntry 0.3s ease-out; }
        .contact-info { flex: 1; cursor: pointer; }
        .last-msg { font-size: 13px; color: #00a884; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .online-status { font-size: 11px; margin-bottom: 2px; }
        .btn-del { background: none; border: none; color: #ef5350; font-size: 18px; padding: 10px; cursor: pointer; opacity: 0.6; }

        #chat-window, #status-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; z-index: 100; display: flex; flex-direction: column; }
        #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background-image: radial-gradient(#202c33 0.5px, transparent 0.5px); background-size: 20px 20px; }
        .msg-bubble { max-width: 80%; padding: 10px; border-radius: 10px; margin-bottom: 8px; position: relative; animation: smoothEntry 0.2s ease-out; color: white; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #005c4b; }
        .msg-them { align-self: flex-start; background: #202c33; }
        
        .input-bar { background: #202c33; padding: 10px; display: flex; align-items: center; gap: 8px; }
        .input-bar input { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 8px; color: white; outline: none; }
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; cursor: pointer; }
        .vn-btn { background: #00a884; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; user-select: none; }
        .vn-recording { background: #ef5350 !important; animation: pulse 0.5s infinite; }
        .file-box { display: block; background: #2a3942; padding: 8px; border-radius: 5px; color: #00ffcc; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body onclick="playClickSound()">

    <div id="welcome-layer"><div class="welcome-text">SELAMAT DATANG</div></div>

    <div id="auth-screen" class="hidden">
        <h2 id="auth-title">Masuk ke MyWA</h2>
        <input type="text" id="my-id-input" placeholder="Masukkan ID...">
        <input type="password" id="my-pw-input" placeholder="Masukkan Password...">
        <div id="reg-extra" class="hidden">
            <input type="text" id="my-recovery-input" placeholder="Kata Kunci Pemulihan (Bebas)...">
            <p style="font-size: 10px; color: #8696a0; margin: 10px;">*Digunakan jika lupa password</p>
        </div>
        <br>
        <button id="btn-main-auth" onclick="handleAuth()">MASUK / DAFTAR</button>
        <button onclick="forgotPassword()" style="background:none; color:#00a884; font-size:12px;">Lupa Password?</button>
    </div>

    <div id="app" class="hidden">
        <header>
            <div id="cool-anim">SISTEM AKTIF ‚Ä¢ TERENKRIPSI</div>
            <h3>Daftar Kontak</h3>
            <button onclick="openAddContact()" style="position:absolute; right:10px; top:12px;">+ ID</button>
            <button onclick="logout()" style="position:absolute; left:10px; top:12px; background:none; font-size:12px;">Logout</button>
        </header>
        
        <div id="status-bar">
            <div class="status-circle" onclick="postStatus()">
                <div class="status-thumb" style="border-style: dashed;">+</div>
                <small>Status</small>
            </div>
            <div id="status-list" style="display: flex; gap: 10px;"></div>
        </div>

        <div class="search-box" style="padding:10px; background:#111b21;"><input type="text" id="search-input" placeholder="Cari..." oninput="renderContacts()" style="width:100%; padding:8px; background:#2a3942; color:white; border:none; border-radius:5px;"></div>
        <div id="contact-outer"><div id="contact-container"><div id="list-kontak"></div></div></div>
    </div>

    <div id="status-viewer" class="hidden" onclick="this.classList.add('hidden')">
        <div id="status-content" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; text-align:center; font-size:24px; background: linear-gradient(45deg, #00a884, #0b141a);"></div>
    </div>

    <div id="chat-window" class="hidden">
        <header style="display:flex; align-items:center; background:#202c33; padding:10px;">
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px; margin-right:15px;">‚Üê</button>
            <div id="chat-target-info"></div>
        </header>
        <div id="msg-area"></div>
        <div class="input-bar">
            <label style="cursor:pointer; font-size: 20px;">üìé<input type="file" id="file-input" class="hidden" onchange="uploadFile()"></label>
            <input type="text" id="text-input" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendText()" oninput="updateTypingStatus()">
            <button onclick="sendText()" id="send-btn">‚û§</button>
            <div id="vn-btn" class="vn-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">üé§</div>
        </div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playClickSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
            authDomain: "mywa-irfank.firebaseapp.com",
            databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
            projectId: "mywa-irfank",
            storageBucket: "mywa-irfank.firebasestorage.app",
            messagingSenderId: "567484997979",
            appId: "1:567484997979:web:743ea53391552dfde07a7e"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();
        
        let myID = localStorage.getItem('my_wa_id');
        let activeChatID = null;
        let mediaRecorder;
        let audioChunks = [];

        function getMyStorage(key) { return JSON.parse(localStorage.getItem(myID + '_' + key) || '{}'); }
        function saveMyStorage(key, data) { localStorage.setItem(myID + '_' + key, JSON.stringify(data)); }

        function encryptText(t) { try { return btoa(unescape(encodeURIComponent(t))); } catch(e) { return t; } }
        function decryptText(e) { try { return decodeURIComponent(escape(atob(e))); } catch(err) { return e; } }

        setTimeout(() => {
            document.getElementById('welcome-layer').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-layer').classList.add('hidden');
                if (!myID) document.getElementById('auth-screen').classList.remove('hidden');
                else startApp();
            }, 500);
        }, 1000);

        async function handleAuth() {
            let id = document.getElementById('my-id-input').value.trim();
            let pw = document.getElementById('my-pw-input').value.trim();
            if (!id || !pw) return;

            const snap = await db.ref('users/' + id).get();
            if (snap.exists()) {
                if (snap.val().pw === pw) proceedLogin(id);
                else alert("Password Salah!");
            } else {
                let regBox = document.getElementById('reg-extra');
                if (regBox.classList.contains('hidden')) {
                    regBox.classList.remove('hidden');
                    document.getElementById('auth-title').innerText = "Daftar ID Baru";
                    alert("ID belum ada. Isi kata kunci pemulihan & klik Daftar lagi.");
                } else {
                    let recovery = document.getElementById('my-recovery-input').value.trim();
                    if (!recovery) return alert("Isi pemulihan!");
                    await db.ref('users/' + id).set({ pw: pw, recovery: recovery, status: 'online', lastSeen: Date.now() });
                    proceedLogin(id);
                }
            }
        }

        async function forgotPassword() {
            let id = prompt("ID Anda:");
            if (!id) return;
            const snap = await db.ref('users/' + id).get();
            if (!snap.exists()) return alert("ID Tidak Ada!");
            let answer = prompt("Kata Kunci Pemulihan:");
            if (answer === snap.val().recovery) {
                let newPw = prompt("Password Baru:");
                if (newPw) {
                    await db.ref('users/' + id).update({ pw: newPw });
                    alert("Berhasil!");
                }
            } else alert("Salah!");
        }

        function proceedLogin(id) {
            localStorage.setItem('my_wa_id', id);
            myID = id;
            startApp();
        }

        function logout() {
            db.ref('users/' + myID).update({ status: 'offline', lastSeen: Date.now(), typing: false });
            localStorage.removeItem('my_wa_id');
            location.reload();
        }

        function startApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            renderContacts();
            listenGlobal();
            listenStatus();
            db.ref('users/' + myID).update({ status: 'online', lastSeen: Date.now() });
            db.ref('users/' + myID).onDisconnect().update({ status: 'offline', lastSeen: Date.now(), typing: false });
        }

        function openAddContact() {
            let target = prompt("ID Tujuan:");
            if (!target || target == myID) return;
            let contacts = getMyStorage('contacts');
            let alias = prompt("Nama Alias:");
            contacts[target] = alias || target;
            saveMyStorage('contacts', contacts);
            renderContacts();
        }

        function renderContacts() {
            const list = document.getElementById('list-kontak');
            const search = document.getElementById('search-input').value.toLowerCase();
            const contacts = getMyStorage('contacts');
            list.innerHTML = '';
            for (let id in contacts) {
                if (id.includes(search) || contacts[id].toLowerCase().includes(search)) {
                    list.innerHTML += `
                        <div class="contact-card">
                            <div class="contact-info" onclick="openChat('${id}')">
                                <b>${contacts[id]}</b> <small style="opacity:0.6; font-size:10px;">(ID: ${id})</small>
                                <div class="online-status" id="stat-${id}">...</div>
                                <div class="last-msg" id="last-${id}">...</div>
                            </div>
                            <button class="btn-del" onclick="deleteContact('${id}')">‚úï</button>
                        </div>`;
                    
                    db.ref(`chats/${myID}/${id}`).limitToLast(1).on('value', s => {
                        let txt = "Belum ada pesan";
                        s.forEach(c => {
                            let m = c.val();
                            if(m.type === 'text') txt = decryptText(m.text);
                            else if(m.type === 'vn') txt = "üé§ Pesan Suara";
                            else txt = "üìé Media";
                        });
                        if(document.getElementById(`last-${id}`)) document.getElementById(`last-${id}`).innerText = txt;
                    });

                    db.ref(`users/${id}`).on('value', snap => {
                        let u = snap.val();
                        let el = document.getElementById(`stat-${id}`);
                        if(!el || !u) return;
                        if(u.typing === myID) el.innerHTML = `<span style="color:#00ffcc">Sedang mengetik...</span>`;
                        else if(u.status === 'online') el.innerHTML = `<span style="color:#00ffcc">‚óè Online</span>`;
                        else {
                            let d = new Date(u.lastSeen);
                            el.innerHTML = `<span style="color:#8696a0">Terakhir dilihat: ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}</span>`;
                        }
                    });
                }
            }
        }

        function openChat(id) {
            activeChatID = id;
            document.getElementById('chat-window').classList.remove('hidden');
            const contacts = getMyStorage('contacts');
            document.getElementById('chat-target-info').innerHTML = `
                <div style="line-height:1.2">
                    <b>${contacts[id] || id}</b><br>
                    <small style="font-size:10px; opacity:0.8">ID: ${id}</small><br>
                    <small id="chat-header-status" style="font-size:10px; color:#00ffcc"></small>
                </div>`;
            
            db.ref(`users/${id}`).on('value', snap => {
                let u = snap.val();
                let el = document.getElementById('chat-header-status');
                if(!el || !u) return;
                if(u.typing === myID) el.innerText = "Sedang mengetik...";
                else if(u.status === 'online') el.innerText = "Online";
                else {
                    let d = new Date(u.lastSeen);
                    el.innerText = `Terakhir dilihat: ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                }
            });

            loadMessages(id);
        }

        function updateTypingStatus() {
            if(!activeChatID) return;
            db.ref('users/' + myID).update({ typing: activeChatID });
            clearTimeout(window.typingTimer);
            window.typingTimer = setTimeout(() => {
                db.ref('users/' + myID).update({ typing: false });
            }, 2000);
        }

        function closeChat() { 
            activeChatID = null; 
            db.ref('users/' + myID).update({ typing: false });
            document.getElementById('chat-window').classList.add('hidden'); 
        }

        function deleteContact(id) {
            if (confirm("Hapus kontak ini?")) {
                let contacts = getMyStorage('contacts');
                delete contacts[id];
                saveMyStorage('contacts', contacts);
                renderContacts();
            }
        }

        function appendMsgToUI(m) {
            const area = document.getElementById('msg-area');
            let isMe = m.sender === myID;
            let content = "";
            if(m.type === 'text') content = decryptText(m.text);
            else if(m.type === 'image') content = `<a href="${m.url}" target="_blank"><img src="${m.url}" class="chat-img"></a>`;
            else if(m.type === 'vn') content = `<audio controls style="max-width:200px"><source src="${m.url}" type="audio/webm"></audio>`;
            else content = `<a href="${m.url}" download class="file-box">üìÑ ${m.fileName}</a>`;

            area.innerHTML += `<div class="msg-bubble ${isMe ? 'msg-me' : 'msg-them'}">${content}
                <div style="font-size:9px;text-align:right;opacity:0.7;margin-top:5px;">${m.timeFull}</div>
            </div>`;
            area.scrollTop = area.scrollHeight;
        }

        function sendText() {
            let txt = document.getElementById('text-input').value;
            if(!txt) return;
            let d = new Date();
            let timeFull = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            let m = { text: encryptText(txt), type: 'text', sender: myID, timeFull: timeFull, ts: Date.now() };
            db.ref(`chats/${myID}/${activeChatID}`).push(m);
            if(activeChatID !== myID) db.ref(`chats/${activeChatID}/${myID}`).push(m);
            document.getElementById('text-input').value = '';
            db.ref('users/' + myID).update({ typing: false });
        }

        function loadMessages(target) {
            const area = document.getElementById('msg-area');
            db.ref(`chats/${myID}/${target}`).off();
            db.ref(`chats/${myID}/${target}`).on('value', snap => {
                area.innerHTML = '';
                snap.forEach(c => appendMsgToUI(c.val()));
                area.scrollTop = area.scrollHeight;
            });
        }

        async function startRecording() {
            try {
                if (mediaRecorder && mediaRecorder.state === "recording") return;
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
                document.getElementById('vn-btn').classList.add('vn-recording');
                playClickSound();
            } catch(err) { alert("Izinkan akses mikrofon!"); }
        }

        function stopRecording() {
            if (!mediaRecorder || mediaRecorder.state === "inactive") return;
            mediaRecorder.stop();
            document.getElementById('vn-btn').classList.remove('vn-recording');
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const fileName = `vn_${Date.now()}.webm`;
                const uploadTask = storage.ref(`uploads/${fileName}`).put(audioBlob);
                
                uploadTask.then(s => s.ref.getDownloadURL()).then(url => {
                    let d = new Date();
                    let timeFull = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                    let m = { url: url, type: 'vn', sender: myID, timeFull: timeFull, ts: Date.now() };
                    db.ref(`chats/${myID}/${activeChatID}`).push(m);
                    if(activeChatID !== myID) db.ref(`chats/${activeChatID}/${myID}`).push(m);
                });
            };
        }

        function uploadFile() {
            let file = document.getElementById('file-input').files[0];
            if(!file) return;
            let isImg = file.type.includes('image');
            storage.ref(`uploads/${Date.now()}_${file.name}`).put(file).then(s => s.ref.getDownloadURL()).then(url => {
                let d = new Date();
                let timeFull = `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                let m = { url: url, type: isImg?'image':'file', fileName: file.name, sender: myID, timeFull: timeFull, ts: Date.now() };
                db.ref(`chats/${myID}/${activeChatID}`).push(m);
                if(activeChatID !== myID) db.ref(`chats/${activeChatID}/${myID}`).push(m);
            });
        }

        function listenGlobal() {
            db.ref(`chats/${myID}`).on('child_added', snap => {
                let foreignID = snap.key;
                let contacts = getMyStorage('contacts');
                if (foreignID === myID || contacts[foreignID]) return;
                let alias = prompt(`Chat baru dari: ${foreignID}\nSimpan sebagai:`);
                contacts[foreignID] = alias || foreignID;
                saveMyStorage('contacts', contacts);
                renderContacts();
            });
        }

        function postStatus() {
            let msg = prompt("Tulis Status (Aktif 24 Jam):");
            if (!msg) return;
            db.ref('status').push({ sender: myID, text: msg, ts: Date.now(), expire: Date.now() + 86400000 });
        }

        function listenStatus() {
            db.ref('status').on('value', snap => {
                const list = document.getElementById('status-list');
                const contacts = getMyStorage('contacts');
                list.innerHTML = '';
                let now = Date.now();
                snap.forEach(c => {
                    let s = c.val();
                    if (now < s.expire) {
                        list.innerHTML += `
                            <div class="status-circle" onclick="viewStatus('${s.text}', '${s.sender}')">
                                <div class="status-thumb">${s.sender.substring(0,2).toUpperCase()}</div>
                                <small>${s.sender === myID ? 'Saya' : (contacts[s.sender] || s.sender)}</small>
                            </div>`;
                    } else db.ref('status/' + c.key).remove();
                });
            });
        }

        function viewStatus(txt, sender) {
            const contacts = getMyStorage('contacts');
            let name = sender === myID ? 'Saya' : (contacts[sender] || sender);
            document.getElementById('status-viewer').classList.remove('hidden');
            document.getElementById('status-content').innerHTML = `<small>Status dari ${name}</small><br><br>${txt}`;
        }
    </script>
</body>
</html>

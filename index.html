<!DOCTYPE html>
<html lang="id">
<head>
Â Â Â  <meta charset="UTF-8">
Â Â Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â Â Â  <title>MyWA - IrfanK Fast</title>
Â Â Â  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
Â Â Â  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
Â Â Â  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

Â Â Â  <style>
Â Â Â Â Â Â Â  * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
Â Â Â Â Â Â Â  body { background-color: #0b141a; color: #e9edef; overflow: hidden; }
Â Â Â Â Â Â Â  .hidden { display: none !important; }

Â Â Â Â Â Â Â  /* Fix Border Chrome vs Browser Lain */
Â Â Â Â Â Â Â  #contact-outer { 
Â Â Â Â Â Â Â Â Â Â Â  flex: 1; 
Â Â Â Â Â Â Â Â Â Â Â  margin: 10px; 
Â Â Â Â Â Â Â Â Â Â Â  border-radius: 15px; 
Â Â Â Â Â Â Â Â Â Â Â  position: relative; 
Â Â Â Â Â Â Â Â Â Â Â  padding: 2px; /* Perkecil padding agar border tidak offset */
Â Â Â Â Â Â Â Â Â Â Â  overflow: hidden; 
Â Â Â Â Â Â Â Â Â Â Â  background: #202c33; /* Warna dasar solid */
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  #contact-outer::before { 
Â Â Â Â Â Â Â Â Â Â Â  content: ""; 
Â Â Â Â Â Â Â Â Â Â Â  position: absolute; 
Â Â Â Â Â Â Â Â Â Â Â  top: -50%; 
Â Â Â Â Â Â Â Â Â Â Â  left: -50%; 
Â Â Â Â Â Â Â Â Â Â Â  width: 200%; 
Â Â Â Â Â Â Â Â Â Â Â  height: 200%; 
Â Â Â Â Â Â Â Â Â Â Â  background: conic-gradient(transparent, transparent, transparent, #00ffcc); 
Â Â Â Â Â Â Â Â Â Â Â  animation: rotateBorder 3s linear infinite; 
Â Â Â Â Â Â Â Â Â Â Â  z-index: 0;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  /* Animasi Mata */
Â Â Â Â Â Â Â  .eye-container { position: fixed; top: 15px; left: 15px; width: 60px; height: 35px; display: flex; gap: 12px; z-index: 2000; pointer-events: none; }
Â Â Â Â Â Â Â  .eye { width: 22px; height: 18px; background: #fff; border-radius: 50% 50% 40% 40%; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1.5px solid #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.3); animation: blinkEye 4s infinite; }
Â Â Â Â Â Â Â  .pupil { width: 9px; height: 9px; background: #000; border-radius: 50%; border: 2px solid #ff0000; animation: creepyLook 3s infinite; }
Â Â Â Â Â Â Â  @keyframes blinkEye { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
Â Â Â Â Â Â Â  @keyframes creepyLook { 0% { transform: translate(0, 0); } 20% { transform: translate(5px, -3px); } 40% { transform: translate(-5px, 3px) scale(1.2); } 60% { transform: translate(0, 5px); } 100% { transform: translate(0, 0); } }

Â Â Â Â Â Â Â  /* Welcome Screen */
Â Â Â Â Â Â Â  #welcome-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 1s; }
Â Â Â Â Â Â Â  .welcome-text { font-size: 24px; font-weight: bold; color: #00a884; animation: pulse 1.5s infinite; }
Â Â Â Â Â Â Â  @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

Â Â Â Â Â Â Â  /* Auth Screen */
Â Â Â Â Â Â Â  #auth-screen { padding: 50px 20px; text-align: center; }
Â Â Â Â Â Â Â  input[type="text"] { width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #2a3942; background: #2a3942; color: white; }
Â Â Â Â Â Â Â  button { background: #00a884; border: none; padding: 10px 20px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }

Â Â Â Â Â Â Â  /* Main App */
Â Â Â Â Â Â Â  #app { display: flex; flex-direction: column; height: 100vh; }
Â Â Â Â Â Â Â  header { background: #202c33; padding: 15px; text-align: center; position: relative; }
Â Â Â Â Â Â Â  #cool-anim { font-size: 14px; color: #00a884; position: absolute; width: 100%; top: 5px; left: 0; animation: slideToggle 2s infinite; }
Â Â Â Â Â Â Â  @keyframes slideToggle { 0%, 100% { transform: translateY(-20px); opacity: 0; } 50% { transform: translateY(0); opacity: 1; } }

Â Â Â Â Â Â Â  @keyframes rotateBorder { 100% { transform: rotate(360deg); } }
Â Â Â Â Â Â Â  #contact-container { position: relative; height: 100%; width: 100%; background: #0b141a; border-radius: 12px; overflow-y: auto; padding: 5px; z-index: 1; }

Â Â Â Â Â Â Â  .search-box { padding: 10px; background: #111b21; }
Â Â Â Â Â Â Â  .search-box input { width: 100%; padding: 8px; border-radius: 5px; border: none; background: #2a3942; color: white; }

Â Â Â Â Â Â Â  .contact-card { background: #111b21; padding: 12px; border-bottom: 1px solid #222d34; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; }
Â Â Â Â Â Â Â  .my-self-card { border-left: 4px solid #00a884; background: #1a2a24; }
Â Â Â Â Â Â Â  .contact-info { flex: 1; cursor: pointer; }
Â Â Â Â Â Â Â  .contact-info b { display: block; color: #e9edef; font-size: 16px; }
Â Â Â Â Â Â Â  .contact-info span { font-size: 12px; color: #8696a0; display: block; margin: 2px 0; }
Â Â Â Â Â Â Â  .last-msg { font-size: 13px; color: #00a884; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
Â Â Â Â Â Â Â  .btn-del { background: none; border: none; color: #ef5350; font-size: 18px; padding: 10px; cursor: pointer; opacity: 0.6; }

Â Â Â Â Â Â Â  /* Chat Window */
Â Â Â Â Â Â Â  #chat-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b141a; z-index: 100; display: flex; flex-direction: column; }
Â Â Â Â Â Â Â  #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
Â Â Â Â Â Â Â  .msg-bubble { max-width: 80%; padding: 10px; border-radius: 10px; margin-bottom: 8px; position: relative; word-wrap: break-word; }
Â Â Â Â Â Â Â  .msg-me { align-self: flex-end; background: #005c4b; }
Â Â Â Â Â Â Â  .msg-them { align-self: flex-start; background: #202c33; }
Â Â Â Â Â Â Â  .msg-time { font-size: 10px; color: #8696a0; text-align: right; margin-top: 5px; }
Â Â Â Â Â Â Â  .status-icon { font-size: 12px; margin-left: 5px; }
Â Â Â Â Â Â Â  .c1, .c2 { color: #8696a0; } .c3 { color: #53bdeb; }

Â Â Â Â Â Â Â  .input-bar { background: #202c33; padding: 10px; display: flex; align-items: center; }
Â Â Â Â Â Â Â  .input-bar input { flex: 1; background: #2a3942; border: none; padding: 10px; border-radius: 8px; color: white; }
Â Â Â Â Â Â Â  .file-btn { margin-right: 10px; font-size: 22px; cursor: pointer; }

Â Â Â Â Â Â Â  .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; border: 1px solid #333; cursor: pointer; }
Â Â Â Â Â Â Â  .download-link { background: #343f46; color: #e9edef; padding: 8px 12px; border-radius: 5px; text-decoration: none; margin-top: 8px; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; border: 1px solid #444; }
Â Â Â  </style>
</head>
<body>

Â Â Â  <div class="eye-container">
Â Â Â Â Â Â Â  <div class="eye"><div class="pupil"></div></div>
Â Â Â Â Â Â Â  <div class="eye"><div class="pupil"></div></div>
Â Â Â  </div>

Â Â Â  <div id="welcome-layer"><div class="welcome-text">SELAMAT DATANG</div></div>

Â Â Â  <div id="auth-screen" class="hidden">
Â Â Â Â Â Â Â  <h2>Bikin ID Permanen</h2>
Â Â Â Â Â Â Â  <input type="text" id="my-id-input" placeholder="Huruf atau Angka...">
Â Â Â Â Â Â Â  <br>
Â Â Â Â Â Â Â  <button id="btn-buat-id" onclick="saveID()">BUAT ID</button>
Â Â Â  </div>

Â Â Â  <div id="app" class="hidden">
Â Â Â Â Â Â Â  <header>
Â Â Â Â Â Â Â Â Â Â Â  <div id="cool-anim">SISTEM AKTIF â€¢ TERENKRIPSI</div>
Â Â Â Â Â Â Â Â Â Â Â  <h3>Daftar Kontak</h3>
Â Â Â Â Â Â Â Â Â Â Â  <button onclick="openAddContact()" style="position:absolute; right:10px; top:12px; padding:5px 10px;">+ ID</button>
Â Â Â Â Â Â Â  </header>
Â Â Â Â Â Â Â  <div class="search-box"><input type="text" id="search-input" placeholder="Cari Nama atau ID..." oninput="renderContacts()"></div>
Â Â Â Â Â Â Â  <div id="contact-outer"><div id="contact-container"><div id="list-kontak"></div></div></div>
Â Â Â  </div>

Â Â Â  <div id="chat-window" class="hidden">
Â Â Â Â Â Â Â  <header style="display:flex; align-items:center; background:#202c33; padding:10px;">
Â Â Â Â Â Â Â Â Â Â Â  <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px; margin-right:15px;">â†</button>
Â Â Â Â Â Â Â Â Â Â Â  <div id="chat-target-info"></div>
Â Â Â Â Â Â Â  </header>
Â Â Â Â Â Â Â  <div id="msg-area"></div>
Â Â Â Â Â Â Â  <div class="input-bar">
Â Â Â Â Â Â Â Â Â Â Â  <label class="file-btn">ğŸ“<input type="file" id="file-input" class="hidden" onchange="uploadFile()"></label>
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" id="text-input" placeholder="Ketik pesan...">
Â Â Â Â Â Â Â Â Â Â Â  <button onclick="sendText()" style="margin-left:10px;">â¤</button>
Â Â Â Â Â Â Â  </div>
Â Â Â  </div>

Â Â Â  <script>
Â Â Â Â Â Â Â  const firebaseConfig = {
Â Â Â Â Â Â Â Â Â Â Â  apiKey: "AIzaSyBndqyGrpv7D-gelmif8YELzs-EJj237MA",
Â Â Â Â Â Â Â Â Â Â Â  authDomain: "mywa-irfank.firebaseapp.com",
Â Â Â Â Â Â Â Â Â Â Â  databaseURL: "https://mywa-irfank-default-rtdb.firebaseio.com",
Â Â Â Â Â Â Â Â Â Â Â  projectId: "mywa-irfank",
Â Â Â Â Â Â Â Â Â Â Â  storageBucket: "mywa-irfank.firebasestorage.app",
Â Â Â Â Â Â Â Â Â Â Â  messagingSenderId: "567484997979",
Â Â Â Â Â Â Â Â Â Â Â  appId: "1:567484997979:web:743ea53391552dfde07a7e"
Â Â Â Â Â Â Â  };

Â Â Â Â Â Â Â  firebase.initializeApp(firebaseConfig);
Â Â Â Â Â Â Â  const db = firebase.database();
Â Â Â Â Â Â Â  const storage = firebase.storage();

Â Â Â Â Â Â Â  let myID = localStorage.getItem('my_wa_id');
Â Â Â Â Â Â Â  let activeChatID = null;
Â Â Â Â Â Â Â  let contacts = JSON.parse(localStorage.getItem('my_contacts') || '{}');

Â Â Â Â Â Â Â  function encryptText(text) { try { return btoa(unescape(encodeURIComponent(text))); } catch(e) { return text; } }
Â Â Â Â Â Â Â  function decryptText(encoded) { try { return decodeURIComponent(escape(atob(encoded))); } catch(e) { return encoded; } }

Â Â Â Â Â Â Â  setTimeout(() => {
Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('welcome-layer').style.opacity = '0';
Â Â Â Â Â Â Â Â Â Â Â  setTimeout(() => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('welcome-layer').classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!myID) document.getElementById('auth-screen').classList.remove('hidden');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else startApp();
Â Â Â Â Â Â Â Â Â Â Â  }, 1000);
Â Â Â Â Â Â Â  }, 2000);

Â Â Â Â Â Â Â  function saveID() {
Â Â Â Â Â Â Â Â Â Â Â  let id = document.getElementById('my-id-input').value.trim();
Â Â Â Â Â Â Â Â Â Â Â  if (!id) return;
Â Â Â Â Â Â Â Â Â Â Â  db.ref('users/' + id).get().then(snap => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (snap.exists()) { alert("ID sudah ada pemiliknya!"); }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  db.ref('users/' + id).set({ status: 'online' });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  localStorage.setItem('my_wa_id', id);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  myID = id;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  startApp();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function startApp() {
Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('auth-screen').classList.add('hidden');
Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('app').classList.remove('hidden');
Â Â Â Â Â Â Â Â Â Â Â  renderContacts();
Â Â Â Â Â Â Â Â Â Â Â  listenGlobal(); // Inilah fungsi yang menangkap chat dari ID lain
Â Â Â Â Â Â Â Â Â Â Â  db.ref('users/' + myID).update({ status: 'online' });
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function openAddContact() {
Â Â Â Â Â Â Â Â Â Â Â  let target = prompt("Masukkan ID tujuan:");
Â Â Â Â Â Â Â Â Â Â Â  if (!target || target == myID) return;
Â Â Â Â Â Â Â Â Â Â Â  let alias = prompt("Beri nama khusus (Alias):");
Â Â Â Â Â Â Â Â Â Â Â  contacts[target] = alias || target;
Â Â Â Â Â Â Â Â Â Â Â  localStorage.setItem('my_contacts', JSON.stringify(contacts));
Â Â Â Â Â Â Â Â Â Â Â  renderContacts();
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function deleteContact(id) {
Â Â Â Â Â Â Â Â Â Â Â  if (confirm(`Hapus ${contacts[id] || id} dari daftar?`)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  delete contacts[id];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  localStorage.setItem('my_contacts', JSON.stringify(contacts));
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  renderContacts();
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function renderContacts() {
Â Â Â Â Â Â Â Â Â Â Â  const list = document.getElementById('list-kontak');
Â Â Â Â Â Â Â Â Â Â Â  const search = document.getElementById('search-input').value.toLowerCase();
Â Â Â Â Â Â Â Â Â Â Â  list.innerHTML = '';

Â Â Â Â Â Â Â Â Â Â Â  if (!search || myID.toLowerCase().includes(search) || "saya".includes(search)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  list.innerHTML += `
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="contact-card my-self-card">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="contact-info" onclick="openChat('${myID}')">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <b>Saya (Simpan Pesan)</b>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span>ID: ${myID}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="last-msg">Catatan pribadi kamu</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>`;
Â Â Â Â Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â Â Â Â Â  for (let id in contacts) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let alias = contacts[id];
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (id.toLowerCase().includes(search) || alias.toLowerCase().includes(search)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let cardID = 'card-' + id.replace(/\s+/g, '-');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  list.innerHTML += `<div id="${cardID}"></div>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  db.ref(`chats/${myID}/${id}`).limitToLast(1).on('value', snap => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let lastMsg = "Belum ada pesan";
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  snap.forEach(c => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let val = c.val();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  lastMsg = val.type === 'text' ? decryptText(val.text) : "ğŸ“ Media/File";
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const targetDiv = document.getElementById(cardID);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (targetDiv) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  targetDiv.innerHTML = `
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="contact-card">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="contact-info" onclick="openChat('${id}')">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <b>${alias}</b>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <span>ID: ${id}</span>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="last-msg">${lastMsg}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button class="btn-del" onclick="deleteContact('${id}')">âœ•</button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function openChat(id) {
Â Â Â Â Â Â Â Â Â Â Â  activeChatID = id;
Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('chat-window').classList.remove('hidden');
Â Â Â Â Â Â Â Â Â Â Â  let displayName = id === myID ? "Simpan Pesan" : (contacts[id] || id);
Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('chat-target-info').innerHTML = `<b>${displayName}</b><br><small style="color:#8696a0">${id}</small>`;
Â Â Â Â Â Â Â Â Â Â Â  loadMessages(id);
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function closeChat() { activeChatID = null; document.getElementById('chat-window').classList.add('hidden'); }

Â Â Â Â Â Â Â  function sendText() {
Â Â Â Â Â Â Â Â Â Â Â  let txt = document.getElementById('text-input').value;
Â Â Â Â Â Â Â Â Â Â Â  if(!txt) return;
Â Â Â Â Â Â Â Â Â Â Â  pushMsg({ text: txt, type: 'text' });
Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('text-input').value = '';
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function pushMsg(data) {
Â Â Â Â Â Â Â Â Â Â Â  let now = new Date();
Â Â Â Â Â Â Â Â Â Â Â  let dateStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
Â Â Â Â Â Â Â Â Â Â Â  let fullDate = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
Â Â Â Â Â Â Â Â Â Â Â  if(data.type === 'text') data.text = encryptText(data.text);
Â Â Â Â Â Â Â Â Â Â Â  let payload = { ...data, sender: myID, time: dateStr, fullDate: fullDate, ts: Date.now(), status: 1 };
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  // Simpan di sisi pengirim
Â Â Â Â Â Â Â Â Â Â Â  db.ref(`chats/${myID}/${activeChatID}`).push(payload);
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  // Simpan di sisi penerima
Â Â Â Â Â Â Â Â Â Â Â  if(activeChatID !== myID) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  db.ref(`chats/${activeChatID}/${myID}`).push(payload);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function loadMessages(target) {
Â Â Â Â Â Â Â Â Â Â Â  const area = document.getElementById('msg-area');

Â Â Â Â Â Â Â Â Â Â  // Matikan listener lama sebelum buka chat baru agar tidak tumpang tindih
Â Â Â Â Â Â Â Â Â Â Â  db.ref(`chats/${myID}/${target}`).off();
Â Â Â Â Â Â Â Â Â Â Â  db.ref(`chats/${myID}/${target}`).on('value', snap => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  area.innerHTML = '';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  snap.forEach(child => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let m = child.val();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let isMe = m.sender === myID;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let content = "";

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if(m.type === 'text') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  content = `<div>${decryptText(m.text)}</div>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } else if(m.type === 'image') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  content = `<img src="${m.url}" class="chat-img" onclick="window.open('${m.url}')"><br><a href="${m.url}" download="${m.fileName}" target="_blank" class="download-link">ğŸ“¥ Download Gambar</a>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } else if(m.type === 'file') {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  content = `<div style="background:rgba(0,0,0,0.1);padding:8px;border-radius:5px;border:1px solid #444">ğŸ“„ ${m.fileName}</div><a href="${m.url}" download="${m.fileName}" target="_blank" class="download-link">ğŸ“¥ Download File</a>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let statusClass = m.status === 3 ? "c3" : (m.status === 2 ? "c2" : "c1");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  area.innerHTML += `
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="msg-bubble ${isMe ? 'msg-me' : 'msg-them'}">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="font-size:9px; opacity:0.7; margin-bottom:3px;">${m.fullDate || ''}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ${content}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div class="msg-time">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ${m.time} ${isMe ? `<span class="status-icon ${statusClass}">âœ“âœ“</span>` : ''}
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  area.scrollTop = area.scrollHeight;
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  function uploadFile() {
Â Â Â Â Â Â Â Â Â Â Â  let fileInput = document.getElementById('file-input');
Â Â Â Â Â Â Â Â Â Â Â  let file = fileInput.files[0];
Â Â Â Â Â Â Â Â Â Â Â  if(!file) return;
Â Â Â Â Â Â Â Â Â Â Â  let fileName = file.name;
Â Â Â Â Â Â Â Â Â Â Â  let isImg = file.type.includes('image');
Â Â Â Â Â Â Â Â Â Â Â  let reader = new FileReader();
Â Â Â Â Â Â Â Â Â Â Â  reader.onload = function(e) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let instantUrl = e.target.result;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let now = new Date();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let dateStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let fullDate = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let payload = { url: instantUrl, type: isImg ? 'image' : 'file', fileName: fileName, sender: myID, time: dateStr, fullDate: fullDate, ts: Date.now(), status: 1 };
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let myMsgRef = db.ref(`chats/${myID}/${activeChatID}`).push(payload);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let targetMsgRef = activeChatID !== myID ? db.ref(`chats/${activeChatID}/${myID}`).push(payload) : null;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let storageRef = storage.ref(`uploads/${Date.now()}_${fileName}`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(realUrl => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  myMsgRef.update({ url: realUrl });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if(targetMsgRef) targetMsgRef.update({ url: realUrl });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â  reader.readAsDataURL(file);
Â Â Â Â Â Â Â Â Â Â Â  fileInput.value = "";
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // FUNGSI DIPERBARUI: Menunggu pesan masuk dan memberi kesempatan penerima memberi nama
Â Â Â Â Â Â Â  function listenGlobal() {
Â Â Â Â Â Â Â Â Â Â Â  db.ref(`chats/${myID}`).on('child_added', snap => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let foreignID = snap.key;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Jika ada ID baru mengirim pesan dan belum ada di daftar kontak kita
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if(!contacts[foreignID] && foreignID !== myID) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Beri notifikasi/prompt ke penerima untuk simpan nama khusus
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  let askAlias = prompt(`Ada pesan masuk dari ID: ${foreignID}\nBeri nama untuk kontak ini agar mudah dikenali:`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Simpan alias sesuai input, jika kosong gunakan ID saja
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  contacts[foreignID] = askAlias || foreignID;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  localStorage.setItem('my_contacts', JSON.stringify(contacts));
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  renderContacts(); // Gambar ulang daftar kontak agar muncul
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }
Â Â Â  </script>
</body>
</html>

